# 微信小程序构建指南

本文档说明如何为不同环境构建微信小程序版本。

## 概述

由于微信小程序不支持动态环境变量，我们通过在构建时动态修改配置文件的方式来适配不同环境。构建脚本会自动处理环境配置替换、进程清理和构建目录清理。

## 环境配置

项目支持以下环境：

| 环境 | 命令 | API地址 | 用途 |
|------|------|---------|------|
| 单元测试 | `npm run build:unit` | - | 单元测试环境 |
| 功能测试 | `npm run build:func` | `http://localhost:9999` | 功能测试环境 |
| UAT测试 | `npm run build:uat` | `https://uat-safeguard-api.example.com` | 用户验收测试 |
| 生产环境 | `npm run build:prod` | `https://flask-7pin-202852-6-1383741966.sh.run.tcloudbase.com` | 生产环境 |

## 构建流程

### 自动化构建步骤

每次运行构建命令时，脚本会自动执行以下步骤：

1. **环境检测与清理**
   - 检测并终止正在运行的微信开发者工具进程
   - 清理旧的构建结果目录
   - 确保构建环境干净

2. **配置文件处理**
   - 备份原始配置文件
   - 根据目标环境动态修改配置文件
   - 临时替换 `config/index.js` 以直接导入对应环境配置
   - 更新对应环境配置文件中的 API 地址

3. **执行构建**
   - 调用 HBuilderX CLI 进行微信小程序构建
   - 生成构建产物到 `src/unpackage/dist/build/mp-weixin`

4. **环境恢复**
   - 恢复所有原始配置文件
   - 确保源代码不受影响

### 构建命令

```bash
# 构建功能测试环境
npm run build:func

# 构建UAT环境
npm run build:uat

# 构建生产环境
npm run build:prod
```

## 构建脚本详解

### build-env.sh

环境构建入口脚本，负责：
- 设置环境变量
- 根据环境类型调用对应的构建逻辑
- 为不同环境传递 `BUILD_ENV` 参数

### mpbuild.sh

微信小程序构建核心脚本，负责：
- 微信开发者工具进程管理
- 构建目录清理
- 配置文件动态修改
- HBuilderX CLI 调用
- 配置文件恢复

## 构建产物

构建完成后，微信小程序项目位于：
```
src/unpackage/dist/build/mp-weixin/
```

该目录包含：
- `app.json` - 小程序配置文件
- `pages/` - 页面文件
- `config/` - 配置文件（已根据环境调整）
- 其他小程序资源文件

## 微信开发者工具使用

### 导入项目

1. 打开微信开发者工具
2. 选择"导入项目"
3. 项目路径选择：`src/unpackage/dist/build/mp-weixin`
4. AppID 设置为：`wx55a59cbcd4156ce4`

### 注意事项

- 构建脚本会自动处理微信开发者工具进程，无需手动关闭
- 如果遇到导入问题，请完全关闭微信开发者工具后重新导入
- 每次构建都会生成全新的构建产物，确保环境隔离

## 故障排除

### 常见问题

1. **构建失败：微信开发者工具进程冲突**
   - 解决方案：脚本会自动清理进程，如果仍有问题请手动关闭

2. **配置未生效**
   - 解决方案：检查构建日志中的环境类型和 API URL 是否正确

3. **导入项目失败**
   - 解决方案：确保选择正确的构建输出目录，完全关闭开发者工具后重新导入

### 调试信息

构建过程中会输出详细的调试信息，包括：
- 环境类型和配置
- 进程清理状态
- API 地址设置
- 构建结果验证

## 开发建议

1. **日常开发**：使用 `npm run build:func` 进行功能测试
2. **测试验证**：使用 `npm run build:uat` 进行用户验收测试
3. **发布部署**：使用 `npm run build:prod` 构建生产版本

## 配置文件结构

```
src/config/
├── index.js      # 配置入口（构建时动态修改）
├── unit.js       # 单元测试环境配置
├── func.js       # 功能测试环境配置
├── uat.js        # UAT环境配置
└── prod.js       # 生产环境配置
```

每个环境配置文件包含：
- 环境标识
- API 配置（baseURL, timeout）
- 应用配置（名称, 版本, 调试开关）
- 功能开关

## 技术实现细节

### 环境变量处理

由于微信小程序限制，采用以下策略：
1. 构建时通过 `sed` 命令动态替换配置
2. 临时修改 `config/index.js` 直接导入目标环境配置
3. 构建完成后恢复所有原始文件

### 进程管理

使用 `pgrep` 和 `pkill` 命令管理微信开发者工具进程：
- 检测进程存在性
- 优雅终止进程
- 必要时强制终止
- 提供详细的状态反馈

### 文件备份与恢复

为确保源代码安全：
- 构建前备份所有将被修改的文件
- 构建后恢复备份文件
- 支持多环境配置文件的独立备份