# 产品需求文档（角色体系重构与监护机制）

## 概述
- 项目类型：前端（含后端接口对接）
- 目标：取消独立“监护人”角色，改为所有注册用户同时具备“打卡人/监护人”双重身份；支持打卡规则与监护人的多对多关系；完成界面与流程改造并实现权限控制。

## 角色体系
- 用户：默认具备双重身份（打卡人、监护人）。
- 社区人员：保留专属入口（Tabbar），预留组织结构接口 `organization_api`。

## 监护机制
- 关系模型：`规则 ↔ 监护人` 多对多。
- 邀请流程：
  - 入口：打卡规则管理界面新增“添加监护人”按钮。
  - 批量选择：支持多选规则后，按微信用户名发起邀请。
  - 选择器：使用微信原生 API 用户选择器组件（小程序/企微环境兼容说明见技术文档）。
- 实时刷新：监护关系建立成功后，前端状态立即刷新，被监护规则以特殊标识显示。

## 时间选择组件规范
- 组件：`uview-plus` 时间选择。
- 预设时间点：
  - 上午：自动定位 `08:00`
  - 中午：自动定位 `12:00`
  - 晚上：自动定位 `19:00`
- 移除“自定义”按钮，直接使用组件原生选择能力。

## 权限与数据
- 权限：接口层进行规则级数据权限校验；查询打卡数据自动过滤无权限记录。
- 数据：新增 `rule_guardianship(rule_id, guardian_id, created_at)`；用户表移除角色类型字段。

## 界面改造
- 移除原“监护人”专属 Tabbar。
- 入口调整：
  - 规则详情页：增加“管理监护人”操作区（列表、添加、移除）。
  - 个人中心：新增“我监护的规则”模块（分页、状态标识）。
- 标识与交互：被监护规则采用显著标签/图标；跨页面保持状态一致与实时更新。

## 里程碑
- 第一阶段：数据库重构与 API 改造；基础监护关系管理。
- 第二阶段：微信邀请对接；界面改造与联调测试。
- 第三阶段：权限控制系统；安全测试与性能优化。

## 扩展性设计
- 社区人员：预留 `organization_api`；角色权限系统可扩展。
- 二期预留：监护提醒 `notify_service`；数据统计 `stats_collector`。

## 验收与指标
- 功能完整度：监护关系增删改查与邀请流程可用。
- 体验一致性：时间选择规范落地、界面标识清晰。
- 安全与性能：权限边界正确；并发与大数据查询性能达标（详见测试计划）。

