# 注册与登录功能设计文档

## 概述

本文档描述了"安卡小习惯"微信小程序的注册与登录功能设计，包括微信快捷登录、手机号登录、角色选择等核心功能的完整设计方案。

## 1. 整体架构

### 1.1 技术栈
- 框架：uni-app + Vue3 + Pinia + SCSS + TypeScript
- UI组件：uview-plus + uni-app内置组件
- 平台：微信小程序专用

### 1.2 开发规范
- 所有组件和页面必须使用 Vue3 的 Composition API 写法（`<script setup>` 语法）
- 使用 rpx 作为响应式单位（1rpx = 0.5px）
- 遵循微信小程序开发规范

## 2. 功能设计

### 2.1 登录流程

#### 2.1.1 微信快捷登录（P0优先级）
1. 用户点击"微信快捷登录"按钮
2. 调用 `uni.login()` 获取微信授权码
3. 调用 `uni.getUserInfo()` 获取用户信息
4. 发送请求到后端验证
5. 根据用户状态跳转：
   - 新用户：角色选择页
   - 老用户未选角色：角色选择页
   - 老用户已选角色：对应角色首页
   - 社区工作人员未验证：身份验证页

#### 2.1.2 手机号登录（P1优先级）
1. 用户点击"手机号登录"入口
2. 输入手机号和验证码
3. 发送验证码（60秒倒计时）
4. 验证登录信息
5. 跳转逻辑同微信登录

### 2.2 角色选择（P0优先级）
支持三种角色：
- 独居者：需要他人关注安全状况
- 监护人：关注亲友安全状况
- 社区工作人员：管理辖区内独居者

### 2.3 社区身份验证（P1优先级）
社区工作人员需要额外提交工作证明进行身份验证。

## 3. UI设计

### 3.1 视觉风格
- 主色调：暖橙色系 (#F48224, #FAE9DB)
- 辅助色：深棕色 (#624731)
- 微信绿色：(#07C160, #00A651)
- 应用名称：安卡小习惯

### 3.2 页面布局
1. **登录页**
   - 顶部：应用Logo和标题
   - 中部：微信快捷登录按钮（大尺寸，绿色渐变）
   - 分割线：灰色细线，中间有"或"文字
   - 中下部：手机号登录入口（橙色边框）
   - 底部：用户协议和隐私政策链接

2. **角色选择页**
   - 顶部：标题和说明文字
   - 中部：三个角色选择卡片
   - 底部：确认选择按钮

### 3.3 响应式设计
- 使用 rpx 单位系统
- 最小触摸区域：88rpx × 88rpx
- 字体大小：基础32rpx，标题48rpx-60rpx
- 按钮高度：96rpx

## 4. 数据流与状态管理

### 4.1 用户状态管理（Pinia）
```javascript
// store/modules/user.js
export const useUserStore = defineStore('user', {
  state: () => ({
    userInfo: null,
    token: null,
    isLoggedIn: false,
    role: null, // 'solo' | 'supervisor' | 'community'
    isLoading: false
  }),
  
  actions: {
    async login(code, userInfo) { /* 登录逻辑 */ },
    logout() { /* 退出登录逻辑 */ },
    initUserState() { /* 初始化用户状态 */ }
  }
})
```

### 4.2 本地存储管理
```javascript
// store/modules/storage.js
export const storage = {
  set(key, value) { /* 存储数据 */ },
  get(key) { /* 读取数据 */ },
  remove(key) { /* 删除数据 */ },
  clear() { /* 清空数据 */ }
}
```

### 4.3 API接口设计
```javascript
// store/api/auth.js
export const authApi = {
  login: (data) => request({ /* 微信登录 */ }),
  getUserInfo: () => request({ /* 获取用户信息 */ }),
  logout: () => request({ /* 退出登录 */ })
}
```

### 4.4 请求封装
```javascript
// store/api/request.js
export const request = (options) => {
  // 统一请求处理
  // 自动添加token
  // 错误处理
  // token过期处理
}
```

## 5. 路由与权限控制

### 5.1 路由配置
- 登录页：/pages/login/login
- 角色选择页：/pages/role-select/role-select
- 社区身份验证页：/pages/community-auth/community-auth

### 5.2 路由守卫
```javascript
// utils/router.js
export function routeGuard(url, options = {}) {
  // 检查是否需要登录
  // 检查角色权限
  // 执行跳转
}
```

### 5.3 页面跳转逻辑
1. 登录成功 → 角色选择（如需要）
2. 角色选择 → 身份验证（社区工作人员）
3. 验证完成 → 对应角色首页

## 6. 错误处理

### 6.1 登录错误类型
- 网络异常：显示"网络连接失败，请重试"
- 用户拒绝授权：显示"需要您的授权才能使用完整功能"
- 服务器异常：显示"登录失败，请稍后重试"
- 无效凭证：显示"登录凭证无效，请重试"

### 6.2 用户体验优化
- 加载状态：半透明遮罩 + 旋转动画
- 错误提示：顶部短暂显示的Toast提示
- 按钮状态：禁用状态 + 加载动画

## 7. 安全考虑

### 7.1 数据安全
- 用户敏感数据加密存储和传输
- 使用HTTPS协议
- Token有效期管理

### 7.2 权限控制
- 基于角色的页面访问控制
- API接口权限验证
- 敏感操作二次确认

## 8. 性能优化

### 8.1 代码优化
- 使用Vue3 Composition API
- 组件懒加载
- 图片资源优化

### 8.2 用户体验
- 页面加载动画
- 按钮反馈效果
- 网络异常重试机制

## 9. 测试策略

### 9.1 功能测试
- 微信登录流程测试
- 角色选择功能测试
- 权限控制测试

### 9.2 兼容性测试
- 不同微信版本兼容性
- 不同设备尺寸适配
- 网络异常情况测试

## 10. 部署与发布

### 10.1 环境配置
- 开发环境配置
- 测试环境配置
- 生产环境配置

### 10.2 发布流程
- 代码审核
- 版本管理
- 小程序提交审核

---

**文档版本**: 1.0  
**创建日期**: 2025-11-26  
**最后更新**: 2025-11-26  
**作者**: iFlow CLI