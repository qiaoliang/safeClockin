# 技术架构文档（角色体系重构与监护机制）

## 系统架构
- 前端：现有前端框架，集成 `uview-plus` 时间选择组件与微信原生用户选择器（按目标运行环境适配）。
- 后端（对接）：提供规则管理与监护关系的 REST/GraphQL API，含权限校验中间件。
- 扩展：
  - 组织结构接口：`organization_api`（社区人员相关）。
  - 通知服务：`notify_service`（监护提醒）。
  - 统计收集：`stats_collector`（数据统计）。

## 数据库模型
- 新表：`rule_guardianship`
  - `rule_id`（外键，指向规则）
  - `guardian_id`（外键，指向用户）
  - `created_at`（时间戳）
  - 唯一约束：`UNIQUE(rule_id, guardian_id)`
- 用户表：移除角色类型字段；通过关系确定监护身份场景。

## 权限控制
- 规则级权限：
  - 请求携带用户身份；在规则/打卡数据查询前进行鉴权。
  - 无权限记录在服务端过滤；统一返回错误码与文案。
- 幂等与并发：
  - 建立监护关系接口具备幂等性；并发场景依赖唯一约束与重试策略。

## 接口定义（示例）
- `POST /rules/{ruleId}/guardians`：添加监护人
  - 入参：`guardianIds: string[]`
  - 返回：成功关系条目列表
- `DELETE /rules/{ruleId}/guardians/{guardianId}`：移除监护人
- `GET /rules/{ruleId}/guardians`：列出规则监护人
- `GET /users/{userId}/guardian-rules`：用户监护的规则列表（分页、状态）
- 邀请接口：
  - `POST /guardians/invite`：通过微信用户名发起邀请（后端校验与消息触达；具体能力视环境）

## 前端实现要点
- 组件集成：
  - 时间选择：使用 `uview-plus`，提供上午/中午/晚上预设并默认定位到 `08:00/12:00/19:00`。
  - 移除“自定义”按钮，保留原生选择器入口。
- 微信用户选择器：
  - 小程序：根据实际能力选择用户标识获取方案（如企业微信 `wx.qy` 能力 `selectEnterpriseContact`）；
  - H5/公众号：若无原生选择器，采用后端映射或账号绑定页作为替代；
  - 以 `wechat_user_selector` 抽象组件封装，环境差异通过适配层处理。
- 状态刷新：
  - 成功建立关系后：触发全局事件/状态更新，刷新规则详情与“我监护的规则”。
  - 页面间同步：使用全局状态管理或事件总线确保一致。

## 界面改造与标识
- 移除监护人专属 Tabbar。
- 规则详情页：管理监护人区（列表、添加、移除、邀请）。
- 个人中心：我监护的规则（分页、状态、标识）。
- 标识规范：统一图标/颜色/标签，遵循无障碍对比度与语义。

## 错误处理与文案
- 权限失败：统一错误码（如 `RULE_FORBIDDEN`），前端提示“无访问权限”。
- 邀请失败：明确原因（用户不存在/环境不支持/网络问题），支持重试。

## 性能与安全
- 查询优化：分页、索引（`rule_id`、`guardian_id`）、必要的聚合缓存。
- 并发控制：接口幂等、唯一约束、短期重试策略。
- 安全：输入校验、鉴权与授权、日志与审计（避免泄露隐私数据）。

## 里程碑与交付
- 阶段一：数据库与 API 完成、基础关系管理打通。
- 阶段二：微信邀请与 UI 改造完成，联调通过。
- 阶段三：权限系统上线、安全测试与性能优化完成。

