# 统一 userState 存储系统设计

## 概述

项目将从旧的分散存储方式完全迁移到新的统一 userState 对象存储系统，删除所有旧存储键的兼容性代码，强制用户重新登录，实现更清晰、更安全的存储架构。

## 设计目标

1. **统一存储**：所有用户相关数据通过 userState 对象统一管理
2. **简化代码**：移除新旧存储系统的兼容性逻辑
3. **提升安全性**：减少存储键的数量，降低安全风险
4. **强制重新登录**：清理旧数据，确保所有用户使用新存储格式

## 实施方案

### 第一阶段：清理 userStore 存储逻辑

**目标**：修改 userStore，只保存和恢复 userState 对象

**具体变更**：
- 修改 `_persistUserState()` 方法，移除所有旧存储键的保存逻辑
- 修改 `_restoreUserState()` 方法，移除旧数据恢复逻辑
- 确保只通过 `storage.set('userState', userState)` 保存数据
- 确保只通过 `storage.get('userState')` 恢复数据

**影响**：
- 用户登录后只会在 storage 中看到 `userState` 和 `secure_seed` 两个键
- 代码逻辑更简洁，维护成本降低

### 第二阶段：重构 request.js 请求拦截器

**目标**：修改请求拦截器完全依赖 userStore

**具体变更**：
- 移除 `storage.get('token')` 等直接访问
- 改为通过 `userStore.token` 获取 token
- 移除 `storage.set('token', newToken)` 等直接设置
- token 刷新后通过 userStore 的 setter 自动保存

**影响**：
- 请求逻辑与存储逻辑完全解耦
- 利用 Pinia 的响应式特性自动处理数据更新

### 第三阶段：清理敏感键列表和存储工具

**目标**：更新安全配置，移除旧存储键

**具体变更**：
- 从 `SENSITIVE_KEYS` 数组移除：`token`、`refreshToken`、`userInfo`、`cached_user_info`
- 保留：`userState`、`secure_seed`
- 检查并移除 storage.js 中的兼容性代码

**影响**：
- 减少需要加密的存储键数量
- 提升加密/解密性能

### 第四阶段：错误处理和边界情况

**目标**：增强数据完整性和错误处理

**具体变更**：
- 添加 userState 结构完整性检查
- 异常时自动重置为默认空状态
- 添加登录状态验证逻辑
- 关键操作前检查用户登录状态

**影响**：
- 提高系统稳定性
- 避免数据结构异常导致的问题

### 第五阶段：测试和验证

**目标**：确保新存储系统正常工作

**测试用例**：
- 用户登录后 userState 正确保存
- 应用重启后 userState 正确恢复
- Token 刷新机制正常工作
- 用户登出后数据完全清理
- 网络异常时的错误处理

### 第六阶段：文档更新

**目标**：更新开发文档和API文档

**更新内容**：
- 新存储架构说明
- 迁移策略文档
- 开发指南更新
- API 文档更新

## 数据流设计

```
用户登录 → userStore.login() → userState 更新 → _persistUserState() → storage.set('userState')
请求拦截 → userStore.token → API 请求 → token 刷新 → userStore 更新 → 自动保存
应用启动 → userStore.initUserState() → storage.get('userState') → 恢复用户状态
用户登出 → userStore.logout() → userState 清空 → storage 清理
```

## 安全考虑

1. **加密存储**：userState 对象整体加密，提升安全性
2. **减少攻击面**：只保留两个存储键，降低风险
3. **数据完整性**：添加结构验证，防止数据篡改
4. **强制重新登录**：清理旧数据，确保安全状态

## 性能优化

1. **减少存储操作**：从多次存储操作减少到一次
2. **响应式更新**：利用 Pinia 响应式特性，减少不必要的保存
3. **缓存机制**：保持现有的缓存机制，提升性能

## 风险评估

1. **用户重新登录**：所有用户需要重新登录，可能影响用户体验
2. **数据丢失**：旧数据将被清理，无法恢复
3. **兼容性**：不再支持旧版本，需要确保所有客户端同步更新

## 回滚计划

如果出现问题，可以通过以下方式回滚：
1. 恢复旧的存储逻辑代码
2. 重新添加兼容性处理
3. 发布紧急修复版本

## 实施时间表

- 第一阶段：1小时
- 第二阶段：1小时  
- 第三阶段：0.5小时
- 第四阶段：1小时
- 第五阶段：2小时
- 第六阶段：0.5小时

总计：6小时

## 验收标准

1. ✅ Storage 中只有 `userState` 和 `secure_seed` 两个键
2. ✅ 所有用户功能正常工作
3. ✅ 用户登录/登出流程正常
4. ✅ Token 刷新机制正常
5. ✅ 测试用例全部通过
6. ✅ 文档更新完成