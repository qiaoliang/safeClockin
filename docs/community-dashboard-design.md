# 社区数字看板设计文档

## 文档信息
- 创建日期：2026-01-07
- 目标用户：社区工作人员（主管、专员）、超级管理员
- 使用场景：日常运营监控、应急响应指挥

---

## 一、页面整体结构

### 1.1 页面布局（自上而下）

```
┌─────────────────────────────────┐
│  顶部导航栏                      │
│  - 页面标题："数据看板"          │
│  - 管理按钮（快捷菜单）          │
├─────────────────────────────────┤
│  事件通知条（条件显示）          │
│  - 横向滚动显示未处理事件        │
│  - 1-3条事件                     │
├─────────────────────────────────┤
│  社区选择器                      │
│  - 下拉选择当前社区              │
├─────────────────────────────────┤
│  数据概览卡片                    │
│  - 用户总数                      │
│  - 今日打卡率                    │
│  - 未打卡人数                    │
├─────────────────────────────────┤
│  历史趋势图表                    │
│  - 打卡率趋势（7天/30天）        │
│  - 各规则逾期情况                │
├─────────────────────────────────┤
│  异常用户清单                    │
│  - 按异常值排序                  │
│  - 显示未完成打卡的用户          │
└─────────────────────────────────┘
```

### 1.2 页面特性
- 垂直滚动布局
- 适配手机端操作
- 信息精简但关键
- 支持下拉刷新
- 支持自动刷新

---

## 二、核心指标计算逻辑

### 2.1 社区整体打卡率

**计算公式：**
```
打卡率 = 所有社区规则的实际打卡次数 ÷ 所有社区规则应打卡次数
```

**详细说明：**
- 应打卡次数 = 社区用户总数 × 社区规则数量
- 实际打卡次数 = 所有用户在所有社区规则上的打卡记录总数

**示例：**
- 社区用户数：100 人
- 社区规则数：3 个
- 应打卡总数：100 × 3 = 300 次
- 实际打卡次数：270 次
- 打卡率：270 ÷ 300 = 90%

### 2.2 未打卡人数

**计算公式：**
```
未打卡人数 = 至少有一个社区规则未打卡的用户数
```

**示例：**
- 社区用户总数：100 人
- 完成所有规则打卡的用户数：87 人
- 未打卡人数：100 - 87 = 13 人

### 2.3 各规则逾期情况

**计算公式：**
```
规则逾期人次 = 该规则在指定时间范围内（如7天）的逾期打卡记录总数
```

**示例：**
- "晨间问候"规则：7天内逾期 15 人次
- "晚间报平安"规则：7天内逾期 8 人次

---

## 三、异常值计算逻辑（核心）

### 3.1 异常值的定义

异常值用于衡量用户未按时打卡的严重程度，是社区数字看板的核心指标。

### 3.2 异常值计算规则

**基本规则：**
```
异常值 = 从计划打卡时间开始，每小时增加 1 点异常值
```

**计算逻辑：**

1. **初始状态**：异常值 = 0

2. **逾期计时**：用户未在计划时间打卡，从计划时间开始计时
   - 逾期 1 小时：异常值 += 1
   - 逾期 2 小时：异常值 += 1（累计为 2）
   - 逾期 3 小时：异常值 += 1（累计为 3）
   - 以此类推...

3. **补打卡**：用户完成补打卡后，异常值停止增加，保持当前值不变

4. **每日记录**：为每个用户记录每个规则在每一天的异常值

**示例：**
- 用户 A 的"晨间问候"规则计划时间：08:00
- 用户 A 实际打卡时间：14:00（逾期 6 小时）
- 用户 A 在该规则当天的异常值 = 6

### 3.3 跨天处理逻辑

**重要规则：**

1. **当日 24:00 后**，异常值停止增加

2. **次日 00:00 开始**，重新计算当日异常值

3. **如果用户前一日未完成打卡且今日未打卡**，则：
   ```
   当日异常值 = 前一日异常值 + 新增异常值
   ```

4. **如果连续多日未打卡**，则：
   ```
   当日异常值从最近一次未打卡的日期开始累计
   ```

5. **直到用户完成打卡**，异常值停止增加

**完整示例：**
- 用户 A 的规则计划时间：08:00
- 第1天：08:00 未打卡，14:00 打卡（异常值 = 14-8 = 6）
- 第2天：08:00 未打卡，14:00 打卡（异常值 = 14-8 = 6）
- 第3天：08:00 未打卡，24:00 仍未打卡（异常值 = 24-8 = 16）
- 第4天：08:00 未打卡，24:00 仍未打卡（异常值 = 16 + (24-8) = 32）
- 第5天：08:00 未打卡，10:00 未打卡（异常值 = 32 + (10-8) = 34）

### 3.4 数据存储需求

**需要记录的信息：**
- 每个用户、每个规则、每天的异常值
- 用户是否完成当日打卡
- 最近一次未打卡的日期
- 支持按日期、规则、用户查询异常值

---

## 四、异常用户筛选逻辑

### 4.1 异常用户的定义

**异常用户 = 满足以下所有条件的用户：**

1. **用户当前总异常值 >= 社区规则数量**
   - 当前总异常值 = 该用户所有未完成打卡的社区规则的异常值之和
   - 已打卡的规则异常值不计算在内

2. **至少有一个规则未完成打卡（未补打卡）**

### 4.2 计算示例

**示例场景：**
- 社区有 3 个规则

**用户 A：**
- 规则1异常值 = 5（已打卡，不计算）
- 规则2异常值 = 3（未打卡，计入）
- 规则3异常值 = 0（已打卡，不计算）
- 当前总异常值 = 3
- 是否显示：是（3 >= 3 且规则2未打卡）

**用户 B：**
- 规则1异常值 = 10（已打卡，不计算）
- 规则2异常值 = 8（已打卡，不计算）
- 规则3异常值 = 6（已打卡，不计算）
- 当前总异常值 = 0
- 是否显示：否（所有规则都已打卡）

### 4.3 异常用户清单展示

**每个用户显示的信息（顺序）：**
1. 用户姓名
2. 异常类型标签（逾期打卡）
3. 未完成的规则数量（如：1个规则未完成）
4. 未完成规则的异常值列表（如：晨间问候：3）
5. 当前总异常值（如：3）
6. 快速操作按钮（查看详情、一键联系）

**异常值分级显示：**
- 轻度异常（1-3）：绿色标签
- 中度异常（4-6）：黄色标签
- 重度异常（7+）：红色标签

**排序规则：**
- 按当前总异常值从高到低排序
- 优先展示逾期最严重的用户

---

## 五、事件通知条设计

### 5.1 触发条件
- 仅当存在未处理的求助事件时显示
- 显示最近 1-3 条未处理事件

### 5.2 每条事件显示的信息
- 事件图标（🔔）
- 事件标题（如：用户求助）
- 事件描述（可选，如：需要紧急帮助）
- 发生时间（如：5分钟前）
- 右箭头（›）

### 5.3 交互方式
- 支持横向滚动查看更多事件
- 点击任意事件跳转到事件详情页
- 在事件详情页可以进行回应、关闭等操作

### 5.4 样式设计
- 背景色：黄色渐变（引起注意）
- 图标动画：轻微摇晃效果
- 点击反馈：按下时轻微缩小

### 5.5 空状态
- 如果没有未处理事件，该区域完全隐藏，不占用空间

---

## 六、历史趋势图表

### 6.1 社区整体打卡率趋势
- 显示最近 7 天或 30 天的打卡率变化曲线
- X 轴：日期
- Y 轴：打卡率百分比（0-100%）
- 支持点击切换时间范围（7天/30天）

### 6.2 各规则逾期情况
- 显示每个社区规则在最近 7 天内的逾期人次
- 使用柱状图展示
- X 轴：规则名称
- Y 轴：逾期人次
- 支持点击柱子查看该规则的详细逾期记录

### 6.3 数据更新策略
- 页面加载时自动获取当日数据
- 下拉刷新时更新所有数据
- 支持手动切换时间范围（7天/30天）

---

## 七、权限控制逻辑

### 7.1 页面访问权限
- ✅ 超级管理员：可以访问
- ✅ 社区主管：可以访问
- ✅ 社区专员：可以访问
- ❌ 普通用户：无权访问，跳转到打卡首页

### 7.2 社区选择权限
- 超级管理员：可查看所有社区
- 社区主管：查看自己管理的社区
- 社区专员：查看自己所属的社区（与社区主管权限相同）

### 7.3 功能操作权限
- 工作人员管理：超级管理员和社区主管有权限
- 用户管理：超级管理员和社区工作人员（主管+专员）有权限
- 一键联系：所有有权限的用户都可以

### 7.4 数据可见性
- 超级管理员：查看所有社区的完整数据
- 社区主管：查看自己管理社区的完整数据
- 社区专员：查看自己所属社区的完整数据（与社区主管权限相同）

### 7.5 无权限处理
- 显示权限提示弹窗
- 提供"返回"按钮跳转到首页

---

## 八、数据更新策略

### 8.1 页面加载时
- 自动获取所有数据（社区统计、打卡数据、异常用户、未处理事件）

### 8.2 自动刷新
- **异常值**：每分钟自动刷新一次（因为异常值随时间增加）
- **事件通知条**：每30秒自动刷新一次（实时性要求高）
- **其他数据**：手动刷新时更新

### 8.3 手动刷新
- 下拉刷新时更新所有数据
- 切换社区时重新加载所有数据

### 8.4 数据缓存
- 非实时数据（如历史趋势）可缓存 5 分钟
- 实时数据（异常值、事件）不缓存，每次都获取最新数据

### 8.5 网络异常处理
- 显示上次成功加载的数据，并标注"数据可能已过期"
- 提供"重试"按钮

### 8.6 性能优化
- 分页加载异常用户列表（每页 20 条）
- 图表数据懒加载（切换到图表标签时才加载）

---

## 九、错误处理与边界情况

### 9.1 网络异常处理
- 显示"网络连接失败"提示
- 提供"重试"按钮
- 保留上次成功加载的数据（如果有）

### 9.2 数据为空处理
- 无未处理事件：隐藏事件通知条
- 无异常用户：显示"暂无异常用户，所有用户都按时打卡"
- 无打卡数据：显示"暂无打卡数据"
- 无社区规则：显示"无社区规则，请工作人员根据实际需要创建"

### 9.3 数据加载失败
- 显示"数据加载失败"提示
- 提供重试按钮
- 记录错误日志

### 9.4 权限不足处理
- 显示"无权限访问"弹窗
- 自动跳转到首页或打卡页

### 9.5 时间边界处理
- 异常值计算：精确到分钟
- 时间显示：自动转换为相对时间（如"5分钟前"）
- 跨天处理：详见第三章"异常值计算逻辑"

### 9.6 性能边界处理
- 异常用户过多：分页加载，每页 20 条
- 规则过多：图表只显示前 10 个，其余折叠
- 数据量过大：显示"加载中"提示

---

## 十、技术实现要点

### 10.1 前端技术栈
- 框架：uni-app (Vue 3)
- 状态管理：Pinia
- UI 组件：uni-ui
- 图表库：echarts-for-uniapp

### 10.2 关键技术点

1. **异常值实时计算**
   - 使用定时器每分钟刷新异常值
   - 前端计算跨天累计逻辑

2. **事件通知自动刷新**
   - 使用 setInterval 每 30 秒刷新事件列表
   - 页面隐藏时暂停刷新，显示时恢复

3. **图表渲染**
   - 使用 echarts 绘制曲线图和柱状图
   - 支持响应式布局

4. **权限控制**
   - 在页面加载时检查用户角色
   - 根据角色过滤可见数据

5. **性能优化**
   - 虚拟列表处理大量数据
   - 图片懒加载
   - 数据分页加载

### 10.3 API 接口需求

1. **获取社区统计数据**
   - 接口：GET /api/community/{community_id}/dashboard-stats
   - 参数：community_id
   - 返回：用户总数、今日打卡率、未打卡人数

2. **获取异常用户列表**
   - 接口：GET /api/community/{community_id}/abnormal-users
   - 参数：community_id, page, page_size
   - 返回：异常用户列表、分页信息

3. **获取历史趋势数据**
   - 接口：GET /api/community/{community_id}/trend-data
   - 参数：community_id, days (7/30), type (checkin_rate/rule_missed)
   - 返回：趋势数据

4. **获取未处理事件**
   - 接口：GET /api/community/{community_id}/pending-events
   - 参数：community_id
   - 返回：未处理事件列表

5. **获取用户异常值详情**
   - 接口：GET /api/community/{community_id}/user-abnormal-value/{user_id}
   - 参数：community_id, user_id
   - 返回：用户各规则的异常值详情

---

## 十一、测试要点

### 11.1 功能测试
- [ ] 页面加载时数据正确显示
- [ ] 异常值计算准确（包括跨天累计）
- [ ] 异常用户筛选逻辑正确
- [ ] 事件通知条显示和隐藏逻辑正确
- [ ] 历史趋势图表数据准确
- [ ] 权限控制正确
- [ ] 数据自动刷新功能正常

### 11.2 性能测试
- [ ] 异常用户列表加载速度
- [ ] 图表渲染性能
- [ ] 自动刷新对性能的影响

### 11.3 边界测试
- [ ] 无数据时的显示
- [ ] 网络异常时的处理
- [ ] 权限不足时的处理
- [ ] 大量数据时的性能
- [ ] 跨天异常值计算准确性

### 11.4 兼容性测试
- [ ] 微信小程序
- [ ] H5 页面
- [ ] 不同屏幕尺寸适配

---

## 十二、后续优化方向

1. **数据可视化增强**
   - 添加更多图表类型
   - 支持数据导出

2. **智能预警**
   - 异常值过高时自动推送通知
   - 打卡率下降趋势预警

3. **工作效率提升**
   - 批量联系功能
   - 快速标记已处理

4. **数据分析**
   - 用户行为分析
   - 规则效果评估

---

## 附录：关键术语表

| 术语 | 定义 |
|------|------|
| 异常值 | 衡量用户未按时打卡严重程度的指标，每小时增加1点 |
| 未打卡用户 | 至少有一个社区规则未打卡的用户 |
| 异常用户 | 当前总异常值 >= 社区规则数量且至少有一个规则未完成打卡的用户 |
| 补打卡 | 用户在计划时间之后完成的打卡 |
| 跨天累计 | 连续多日未打卡时，异常值从最近一次未打卡日期开始累计 |
| 社区规则 | 社区为用户设定的打卡规则（如晨间问候、晚间报平安） |
| 打卡率 | 所有社区规则的实际打卡次数 ÷ 所有社区规则应打卡次数 |

---

**文档版本：v1.0**
**最后更新：2026-01-07**