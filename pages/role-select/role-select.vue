<template>
  <view class="role-select-container">
    <!-- é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ -->
    <view class="header-section">
      <view class="logo-section">
        <view class="logo-circle">
          <text class="logo-icon">ğŸ›¡ï¸</text>
        </view>
        <text class="app-title">å®‰å…¨å®ˆæŠ¤</text>
        <text class="app-subtitle">è®©å…³çˆ±æ— å¤„ä¸åœ¨</text>
      </view>
      
      <text class="page-title">è¯·é€‰æ‹©æ‚¨çš„è§’è‰²</text>
      <text class="page-subtitle">é€‰æ‹©æœ€ç¬¦åˆæ‚¨èº«ä»½çš„è§’è‰²ï¼Œå¼€å§‹ä½¿ç”¨å®‰å…¨å®ˆæŠ¤</text>
    </view>

    <!-- è§’è‰²é€‰æ‹©å¡ç‰‡ -->
    <view class="role-selection">
      <!-- ç‹¬å±…è€…è§’è‰²å¡ç‰‡ -->
      <view 
        class="role-card" 
        :class="{ 'selected': selectedRole === 'solo' }"
        @tap="selectRole('solo')"
      >
        <view class="role-icon">
          <text class="role-icon-text">ğŸ‘¤</text>
        </view>
        <view class="role-content">
          <text class="role-title">ç‹¬å±…è€…</text>
          <text class="role-description">æˆ‘æ˜¯ç‹¬å±…ç”Ÿæ´»çš„æœ‹å‹ï¼Œå¸Œæœ›é€šè¿‡æ‰“å¡è®©å®¶äººæ”¾å¿ƒ</text>
          <view class="role-features">
            <view class="feature-item">
              <text class="feature-icon">âœ…</text>
              <text class="feature-text">æ¯æ—¥æ‰“å¡</text>
            </view>
            <view class="feature-item">
              <text class="feature-icon">ğŸ‘¥</text>
              <text class="feature-text">äº²å‹ç›‘ç£</text>
            </view>
          </view>
        </view>
      </view>

      <!-- äº²å‹ç›‘ç£äººè§’è‰²å¡ç‰‡ -->
      <view 
        class="role-card" 
        :class="{ 'selected': selectedRole === 'supervisor' }"
        @tap="selectRole('supervisor')"
      >
        <view class="role-icon">
          <text class="role-icon-text">â¤ï¸</text>
        </view>
        <view class="role-content">
          <text class="role-title">äº²å‹ç›‘ç£äºº</text>
          <text class="role-description">æˆ‘å…³å¿ƒç‹¬å±…çš„äº²å‹ï¼Œå¸Œæœ›å®æ—¶äº†è§£ä»–ä»¬çš„çŠ¶å†µ</text>
          <view class="role-features">
            <view class="feature-item">
              <text class="feature-icon">ğŸ‘ï¸</text>
              <text class="feature-text">å®æ—¶å…³æ³¨</text>
            </view>
            <view class="feature-item">
              <text class="feature-icon">ğŸ“</text>
              <text class="feature-text">ä¸€é”®è”ç³»</text>
            </view>
          </view>
        </view>
      </view>

      <!-- ç¤¾åŒºå·¥ä½œäººå‘˜è§’è‰²å¡ç‰‡ -->
      <view 
        class="role-card" 
        :class="{ 'selected': selectedRole === 'community' }"
        @tap="selectRole('community')"
      >
        <view class="role-icon">
          <text class="role-icon-text">ğŸ‘¥</text>
        </view>
        <view class="role-content">
          <text class="role-title">ç¤¾åŒºå·¥ä½œäººå‘˜</text>
          <text class="role-description">æˆ‘è´Ÿè´£ç¤¾åŒºç‹¬å±…è€…ç®¡ç†ï¼Œéœ€è¦é«˜æ•ˆçš„å·¥ä½œå·¥å…·</text>
          <view class="role-features">
            <view class="feature-item">
              <text class="feature-icon">ğŸ“Š</text>
              <text class="feature-text">æ•°æ®ç®¡ç†</text>
            </view>
            <view class="feature-item">
              <text class="feature-icon">ğŸ””</text>
              <text class="feature-text">æ‰¹é‡æé†’</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨è¯´æ˜ -->
    <view class="footer-section">
      <view class="info-card">
        <view class="info-icon">
          <text class="info-icon-text">â„¹ï¸</text>
        </view>
        <text class="info-text">é€‰æ‹©è§’è‰²åï¼Œæ‚¨å¯ä»¥å¼€å§‹ä½¿ç”¨ç›¸åº”çš„åŠŸèƒ½ã€‚å¦‚éœ€åˆ‡æ¢è§’è‰²ï¼Œè¯·åœ¨ä¸ªäººä¸­å¿ƒé‡æ–°è®¾ç½®ã€‚</text>
      </view>
    </view>

    <!-- ç¡®è®¤é€‰æ‹©æŒ‰é’® -->
    <view class="confirm-section">
      <button 
        class="confirm-btn" 
        :disabled="!selectedRole"
        :class="{ 'disabled': !selectedRole }"
        @tap="confirmSelection"
      >
        ç¡®è®¤é€‰æ‹©
      </button>
    </view>
  </view>
</template>

<script setup>
import { ref, onLoad } from 'vue'
import { useUserStore } from '@/store/modules/user'
import { getHomePageByRole } from '@/utils/router'

// å“åº”å¼æ•°æ®
const selectedRole = ref('')
const userStore = useUserStore()

// é€‰æ‹©è§’è‰²
const selectRole = (role) => {
  selectedRole.value = role
  
  // æ·»åŠ è§¦è§‰åé¦ˆ
  uni.vibrateShort({
    type: 'light'
  })
}

// ç¡®è®¤é€‰æ‹©
const confirmSelection = async () => {
  if (!selectedRole.value) {
    uni.showToast({
      title: 'è¯·é€‰æ‹©ä¸€ä¸ªè§’è‰²',
      icon: 'none'
    })
    return
  }

  try {
    // æ˜¾ç¤ºåŠ è½½æç¤º
    uni.showLoading({
      title: 'æ­£åœ¨è®¾ç½®...'
    })

    // æ›´æ–°ç”¨æˆ·è§’è‰²
    await userStore.updateUserRole(selectedRole.value)

    // éšè—åŠ è½½æç¤º
    uni.hideLoading()

    // æ ¹æ®è§’è‰²è·³è½¬åˆ°å¯¹åº”é¡µé¢
    if (selectedRole.value === 'community') {
      // ç¤¾åŒºå·¥ä½œäººå‘˜éœ€è¦èº«ä»½éªŒè¯
      uni.redirectTo({
        url: '/pages/community-auth/community-auth'
      })
    } else {
      // å…¶ä»–è§’è‰²è·³è½¬åˆ°å¯¹åº”é¦–é¡µ
      const homePage = getHomePageByRole(selectedRole.value)
      uni.redirectTo({
        url: homePage
      })
    }

    uni.showToast({
      title: 'è§’è‰²è®¾ç½®æˆåŠŸ',
      icon: 'success'
    })

  } catch (error) {
    console.error('è§’è‰²è®¾ç½®å¤±è´¥:', error)
    uni.hideLoading()
    uni.showToast({
      title: 'è®¾ç½®å¤±è´¥ï¼Œè¯·é‡è¯•',
      icon: 'none'
    })
  }
}

// é¡µé¢åŠ è½½æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
onLoad(() => {
  // å¦‚æœç”¨æˆ·å·²ç»æœ‰è§’è‰²ï¼Œç›´æ¥è·³è½¬åˆ°å¯¹åº”é¡µé¢
  if (userStore.userInfo?.role) {
    const homePage = getHomePageByRole(userStore.userInfo.role)
    uni.redirectTo({
      url: homePage
    })
  }
})
</script>

<style lang="scss" scoped>
.role-select-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #FAE9DB 0%, #F8E0D0 100%);
  padding-bottom: 40rpx;
}

.header-section {
  padding: 60rpx 48rpx 48rpx;
  text-align: center;
}

.logo-section {
  margin-bottom: 64rpx;
}

.logo-circle {
  width: 160rpx;
  height: 160rpx;
  background: white;
  border-radius: 50%;
  box-shadow: 0 8rpx 24rpx rgba(0, 0, 0, 0.08);
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 32rpx;
}

.logo-icon {
  font-size: 64rpx;
}

.app-title {
  display: block;
  font-size: 48rpx;
  font-weight: bold;
  color: #624731;
  margin-bottom: 16rpx;
}

.app-subtitle {
  display: block;
  font-size: 28rpx;
  color: #666;
}

.page-title {
  display: block;
  font-size: 40rpx;
  font-weight: 600;
  color: #624731;
  margin-bottom: 16rpx;
}

.page-subtitle {
  display: block;
  font-size: 28rpx;
  color: #666;
  line-height: 1.5;
}

.role-selection {
  padding: 0 48rpx;
}

.role-card {
  background: white;
  border-radius: 40rpx;
  box-shadow: 0 8rpx 24rpx rgba(0, 0, 0, 0.08);
  padding: 48rpx;
  margin-bottom: 48rpx;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;

  &:active {
    transform: scale(0.98);
  }

  &.selected {
    border: 6rpx solid #F48224;
    box-shadow: 0 0 0 8rpx rgba(244, 130, 36, 0.1);
  }
}

.role-icon {
  background: linear-gradient(135deg, #FAE9DB 0%, #F8E0D0 100%);
  border-radius: 50%;
  width: 160rpx;
  height: 160rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 32rpx;
}

.role-icon-text {
  font-size: 64rpx;
}

.role-content {
  text-align: center;
}

.role-title {
  display: block;
  font-size: 36rpx;
  font-weight: 600;
  color: #624731;
  margin-bottom: 16rpx;
}

.role-description {
  display: block;
  font-size: 28rpx;
  color: #666;
  line-height: 1.6;
  margin-bottom: 32rpx;
}

.role-features {
  display: flex;
  justify-content: center;
  gap: 48rpx;
}

.feature-item {
  display: flex;
  align-items: center;
  gap: 8rpx;
  font-size: 24rpx;
  color: #888;
}

.feature-icon {
  font-size: 24rpx;
}

.feature-text {
  font-size: 24rpx;
}

.footer-section {
  padding: 32rpx 48rpx;
}

.info-card {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 32rpx;
  padding: 32rpx;
  display: flex;
  align-items: flex-start;
  gap: 24rpx;
}

.info-icon {
  width: 48rpx;
  height: 48rpx;
  background: #E0F2FE;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  margin-top: 4rpx;
}

.info-icon-text {
  font-size: 24rpx;
}

.info-text {
  font-size: 28rpx;
  color: #666;
  line-height: 1.6;
  flex: 1;
}

.confirm-section {
  padding: 0 48rpx;
  margin-top: 48rpx;
}

.confirm-btn {
  width: 100%;
  height: 96rpx;
  background: linear-gradient(135deg, #F48224 0%, #E67E22 100%);
  color: white;
  border: none;
  border-radius: 48rpx;
  font-size: 36rpx;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4rpx 16rpx rgba(244, 130, 36, 0.3);
  transition: all 0.3s ease;

  &:active {
    transform: scale(0.98);
  }

  &.disabled {
    background: #ccc;
    box-shadow: none;
    opacity: 0.6;
  }
}
</style>